package com.zongteng.ztetl.util.ods.script

import java.io.{File, FileOutputStream}

import scala.collection.mutable.ListBuffer

object OdsStreamScript {

  // 将样例类脚本输出到指定的目录
  def outputCaseClassScript(datasourceNumId: String, mysqlTable: String, mysqlFiles: ListBuffer[String]) = {

    // 将表名去掉下划线，用驼峰命名法命名
    val caseClassName: String = mysqlTable.split("_").map(str => {
      str.substring(0, 1).toUpperCase + str.substring(1)
    }).mkString("")

    val packageScript = s"package com.zongteng.ztetl.entity.$datasourceNumId + \n"

    val caseClassScriptHeap = s"case class $caseClassName ("

    val caseClassScriptTail = ")"

    val mysqlFileds2: ListBuffer[String] = mysqlFiles.map(filed => {
      "    " + filed.replace(",",  "") + ": String,"
    })
    mysqlFileds2.update(mysqlFileds2.length - 1,  mysqlFileds2.last.substring(0, mysqlFileds2.last.lastIndexOf(",")))

    val caseClassScripts = packageScript :: caseClassScriptHeap :: mysqlFileds2.toList ::: caseClassScriptTail :: Nil
    
    val caseClassPath: String = getCaseClassPath(datasourceNumId, caseClassName)

    println("caseClass样例类路径：" + caseClassPath)

    var stream: FileOutputStream = null
    try {

      stream = new FileOutputStream(caseClassPath)
      caseClassScripts.foreach((x: String) => {
        stream.write(x.getBytes)
        stream.write("\r\n".getBytes()) // 换行
      })
    } catch {
      case e: Exception => println("sqoop_io异常：检查目录是否存在")
    } finally {
      stream.close()
    }

  }

  /**
    * 通过数据库唯一编号（GC_OMS，GC_WMS，ZY_WMS）和mysql表名，获取样例类应该存放的路径
    * @param datasourceNumId GC_OMS，GC_WMS，ZY_WMS
    * @param caseClassName  样例类
    */
  def getCaseClassPath(datasourceNumId: String, caseClassName: String) = {

    var datasourceNumId2 = datasourceNumId

    if (datasourceNumId.startsWith("gc_lms")) {
      datasourceNumId2 = "gc_lms\\" +  datasourceNumId
    } else if (datasourceNumId.startsWith("gc_owms")) {
      datasourceNumId2 = "gc_owms\\" +  datasourceNumId
    } else if (datasourceNumId.startsWith("zy_owms")) {
      datasourceNumId2 = "zy_owms\\" +  datasourceNumId
    }

    val classFile: String = "com\\zongteng\\ztetl\\entity\\" + datasourceNumId2
    val caseClassPath: String = getClass.getClassLoader.getResource(classFile).getPath + "/" + caseClassName + ".scala"

    //  类路径下的：    F:/project/IdeaProjects2/trunk/target/classes/com/zongteng/ztetl/entity/gc_wms/AdvancePickingDetail.scala
    //  idea路径下的：  F:\project\IdeaProjects2\trunk\src\main\scala\com\zongteng\ztetl\entity\gc_wms
    val path: String = caseClassPath.replace("%5c", "/").replace("target/classes", "src\\main\\scala")

    // 如果文件已经存在，那么删除
    val file = new File(path)
    if (file.isFile && file.exists()) {
      file.deleteOnExit()
    }

    path
  }

  def main(args: Array[String]): Unit = {
    outputCaseClassScript("gc_wms", "advance_picking_detail", ListBuffer("AA", "BB"))
  }


}
